<%- contentFor('HeaderCss') %> <%- include ('../partials/title-meta',
{"title":"Accounts"}) %>
<!-- DataTables -->
<link
  href="/assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css"
  rel="stylesheet"
  type="text/css"
/>

<!-- Responsive datatable examples -->
<link
  href="/assets/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css"
  rel="stylesheet"
  type="text/css"
/>
<link
  href="/assets/libs/select2/css/select2.min.css"
  rel="stylesheet"
  type="text/css"
/>
<style>
  .select2-container--default .select2-dropdown {
    z-index: 9999 !important; /* Ensure dropdown is above modal */
  }

  .select2-container--default .select2-selection--single {
    height: auto !important;
  }
</style>
<%- contentFor('body') %> <%- include ('../partials/page-title', {"pagetitle":
"Accounts Table" , "title" : "Accounts Table" }) %>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="row card-title mt-3">
        <div class="col-md-8">
          <h4 class="card-title">Accounts</h4>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary" id="openModal">Add New A/C</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary ml-3" id="openSubModal">
            Add New S.A/C
          </button>
        </div>
      </div>
      <div class="card-body">
        <table
          id="datatable"
          class="table table-bordered dt-responsive nowrap w-100"
        >
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Balance</th>
              <th>Notes</th>
            </tr>
          </thead>

          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- end col -->
</div>
<!-- end row -->
<!-- Start Model -->
<div
  class="modal fade"
  id="userModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="row px-2 mt-1">
        <div class="col-md-4">
          <span>A/C ID: <%- account_pk %></span>
        </div>
        <div class="col-md-7">
          <h3>ADD Account</h3>
        </div>
        <div class="col-md-1">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
      </div>
      <div class="modal-body">
        <form id="modalForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="username" class="col-form-label">Title:</label>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  required
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="notes" class="col-form-label">Notes:</label>
                <input type="text" class="form-control" id="notes" required />
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          id="closeModalButton"
          data-bs-dismiss="modal"
        >
          Close
        </button>
        <button type="submit" class="btn btn-primary" form="modalForm">
          Submit
        </button>
      </div>
    </div>
  </div>
</div>
<!-- End Modal -->

<!-- Start Sub Account Model -->
<div
  class="modal fade"
  id="subAccountModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="row px-2 mt-1">
        <div class="col-md-4">
          <span>S. A/C: <%- account_pk %></span>
        </div>
        <div class="col-md-7">
          <strong>Add New Sub-Account</strong>
        </div>
        <div class="col-md-1">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
      </div>
      <div class="modal-body">
        <form id="modalForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="username" class="col-form-label">Title:</label>
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  required
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="notes" class="col-form-label">Website:</label>
                <input type="text" class="form-control" id="notes" required />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mt-2">
              <div class="mb-3">
                <label class="form-label">Parent Account</label>
                <select class="form-control select2" style="width: 100%;">
                  <option value="AK">Alaska</option>
                  <option value="HI">Hawaii</option>
                  <option value="CA">California</option>
                  <option value="NY">New York</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="notes" class="col-form-label">Notes:</label>
                <input type="text" class="form-control" id="notes" required />
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          id="closeModalButton"
          data-bs-dismiss="modal"
        >
          Close
        </button>
        <button type="submit" class="btn btn-primary" form="modalForm">
          Submit
        </button>
      </div>
    </div>
  </div>
</div>
<!-- End Sub Account Model -->

<%- contentFor('FooterJs') %>
<!-- Required datatable js -->
<script src="/assets/libs/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/assets/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>

<!-- Responsive examples -->
<script src="/assets/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="/assets/libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js"></script>

<!-- Datatable init js -->
<script src="/assets/js/pages/datatables.init.js"></script>
<!-- Select 2 -->
<script src="/assets/libs/select2/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    // Initialize DataTable
    const dataTable = $("#datatable").DataTable();
    // Function to fetch all companies and update the DataTable
    var companyId = window.location.pathname.split("/")[2]; // Assuming URL format is /companies/:id
    function fetchUsersTable() {
      $.ajax({
        type: "GET",
        url: `/companies/${companyId}/users/ajax?user_type=User`, // Adjust the endpoint to fetch all companies
        success: function (response) {
          // Clear the current table data
          dataTable.clear();

          // Loop through all companies and append them to the table
          response.users.forEach(function (user) {
            dataTable.row.add([
              user.account_pk, // Company Name
              user.username, // Company ID
              user.balance, // Company ID
              user.notes,
            ]);
          });

          // Draw the table to display the updated data
          dataTable.draw();
          // Add event listener to the "show" links
          $(".show-company").click(function () {
            // Get the company ID from the clicked link's data-id attribute
            var companyId = $(this).data("id");

            // Store the company ID in localStorage
            localStorage.setItem("company_id", companyId);

            // Show the relevant sidebar links
            showSidebarLinks(companyId);
          });
        },
        error: function (error) {
          console.log(error);
          // alert("Error fetching updated companies list.");
        },
      });
    }
    // Check if a company_id exists in localStorage on page load
    var storedCompanyId = localStorage.getItem("company_id");
    // Get the modal and the open modal button
    var modal = new bootstrap.Modal(document.getElementById("userModal"), {
      keyboard: false,
    });

    // Get the sub Account modal and the open modal button
    var subAccountmodal = new bootstrap.Modal(
      document.getElementById("subAccountModal"),
      {
        keyboard: false,
      }
    );

    // Open the modal when the "Add+" button is clicked
    $("#openModal").click(function () {
      modal.show(); // Show the modal using Bootstrap's modal API
    });

    // Open the sub account modal when the "Add+" button is clicked
    $("#openSubModal").click(function () {
      subAccountmodal.show(); // Show the modal using Bootstrap's modal API
      $(".select2").select2({
        minimumResultsForSearch: 0,
        dropdownParent: $('#subAccountModal')
      });
    });

    // Close the modal when the "close" button (X) is clicked
    $("#closeModalButton").click(function () {
      modal.hide(); // Hide the modal using Bootstrap's modal API
    });

    // Close the modal when the user clicks outside of the modal
    $(window).click(function (event) {
      if ($(event.target).is(modal._element)) {
        modal.hide(); // Hide the modal if the user clicks outside of it
      }
    });

    // Handle form submission inside the modal
    $("#modalForm").submit(function (event) {
      event.preventDefault(); // Prevent the default form submission behavior

      // Get the value from the form input (company name)
      var username = $("#username").val();
      var notes = $("#notes").val();
      var user_type = "User";
      var companyId = window.location.pathname.split("/")[2]; // Assuming URL format is /companies/:id

      // Example of submitting the form data to the backend (using AJAX)
      $.ajax({
        type: "POST",
        url: `/companies/${companyId}/users`, // Adjust this to your API endpoint
        data: {
          company_id: companyId,
          username: username,
          user_type: user_type,
          notes: notes,
        },
        success: function (response) {
          // Call the GET method to fetch and update the table
          fetchUsersTable();
          //   alert("Company submitted successfully!");
          modal.hide(); // Hide the modal after successful submission
          $("#modalForm")[0].reset(); // Reset the form
        },
        error: function (error) {
          alert("Error submitting the company. Please try again.");
        },
      });
    });
    // Function to show the sidebar links based on company_id in localStorage
    function showSidebarLinks(companyId) {
      // Show the sidebar links for the selected company
      $("#accountsLink").removeClass("d-none");
      $("#usersLink").removeClass("d-none");
      $("#importsLink").removeClass("d-none");
      $("#accountstypeLink").removeClass("d-none");

      // Set the correct href for each link
      $("#accountsLink a").attr(
        "href",
        "/companies/" + companyId + "/account_types"
      );
      $("#usersLink a").attr("href", "/companies/" + companyId + "/users");
      $("#importsLink a").attr("href", "/companies/" + companyId + "/imports");
      $("#accountstypeLink a").attr(
        "href",
        "/companies/" + companyId + "/account_types"
      );
    }

    // If a company_id exists, display the relevant links in the sidebar
    if (storedCompanyId) {
      showSidebarLinks(storedCompanyId);
    }
    fetchUsersTable();
  });
</script>
